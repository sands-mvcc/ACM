<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMMC Access Control Matrix</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: {
                850: '#1e293b',
              }
            }
          }
        }
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Modal Transition */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }

        /* Print Styles */
        @media print {
            @page { size: landscape; margin: 0.5in; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .page-break { page-break-before: always; }
            /* Hide scrollbars and sidebar */
            nav, header, button, .modal { display: none !important; }
            #main-content { margin: 0; padding: 0; overflow: visible; }
            #dashboard-container { display: block; height: auto; overflow: visible; }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 h-screen flex flex-col overflow-hidden">

    <!-- Application Root -->
    <div id="app" class="h-full w-full"></div>

    <!-- Modal Overlay (Hidden by default) -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-95" id="modal-content">
            <!-- Content injected via JS -->
        </div>
    </div>

    <script>
        // --- ICONS (SVG Strings) ---
        const icons = {
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
            printer: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
            user: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            logo: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`
        };

        // --- STATE MANAGEMENT ---
        const INITIAL_STATE = {
            metadata: { organizationName: '', author: '', facilities: '', dateCompleted: '', nextReviewDate: '' },
            techEntries: [],
            sharedEntries: [],
            cmmcEntries: []
        };

        let state = {
            currentUser: localStorage.getItem('cmmc-session-user'),
            activeTab: 'intro',
            data: INITIAL_STATE,
            isRegistering: false // for auth screen toggling
        };

        // Modal State
        let modalContext = {
            type: '', // 'techEntries', 'sharedEntries', 'cmmcEntries'
            editingId: null
        };

        // --- DATA PERSISTENCE ---
        function loadUserData() {
            if (!state.currentUser) return;
            const key = `cmmc-acm-data-${state.currentUser}`;
            const saved = localStorage.getItem(key);
            state.data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(INITIAL_STATE));
        }

        function saveUserData() {
            if (!state.currentUser) return;
            const key = `cmmc-acm-data-${state.currentUser}`;
            localStorage.setItem(key, JSON.stringify(state.data));
        }

        // --- RENDER FUNCTIONS ---

        const appDiv = document.getElementById('app');

        function render() {
            if (!state.currentUser) {
                renderAuthScreen();
            } else {
                renderDashboard();
            }
        }

        function renderAuthScreen() {
            const isReg = state.isRegistering;
            appDiv.innerHTML = `
                <div class="min-h-screen bg-slate-900 flex items-center justify-center p-4 animate-fadeIn">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div class="bg-blue-600 p-6 text-center">
                            <div class="bg-blue-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                                ${icons.user.replace('width="20"', 'width="32"').replace('height="20"', 'height="32"').replace('currentColor', 'white')}
                            </div>
                            <h1 class="text-2xl font-bold text-white">CMMC Matrix Builder</h1>
                            <p class="text-blue-100 text-sm mt-1">Access Control & Compliance Tool</p>
                        </div>

                        <div class="p-8">
                            <div class="text-center mb-6">
                                <h2 class="text-xl font-semibold text-gray-800">${isReg ? 'Create Account' : 'Welcome Back'}</h2>
                                <p class="text-gray-500 text-sm mt-1">${isReg ? 'Enter details to start' : 'Sign in to access data'}</p>
                            </div>
                            
                            <div id="auth-error" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-lg mb-6 border border-red-100"></div>

                            <form id="auth-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input type="text" name="username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition">
                                    ${isReg ? 'Sign Up' : 'Login'}
                                </button>
                            </form>

                            <div class="mt-6 text-center">
                                <button id="toggle-auth" class="text-sm text-blue-600 hover:text-blue-800 font-medium hover:underline">
                                    ${isReg ? 'Already have an account? Login' : "Don't have an account? Sign Up"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            appDiv.innerHTML = `
                <div id="dashboard-container" class="h-full flex flex-col bg-gray-50">
                    <!-- Header -->
                    <header class="bg-slate-900 text-white shadow-md z-10 flex-shrink-0 no-print">
                        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-500 rounded-lg">${icons.logo}</div>
                                <div>
                                    <h1 class="text-xl font-bold tracking-tight">CMMC Matrix Builder</h1>
                                    <p class="text-xs text-slate-400">Educational Tool</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 text-sm bg-slate-800 py-1.5 px-3 rounded-full border border-slate-700">
                                    ${icons.user} <span class="text-slate-200 font-medium">${state.currentUser}</span>
                                </div>
                                <div class="h-6 w-px bg-slate-700"></div>
                                <button onclick="downloadJSON()" class="hidden sm:flex items-center gap-2 px-3 py-2 hover:bg-slate-800 rounded text-sm text-slate-300 hover:text-white" title="Download">${icons.download}</button>
                                <button onclick="printReport()" class="hidden sm:flex items-center gap-2 px-3 py-2 hover:bg-slate-800 rounded text-sm text-slate-300 hover:text-white" title="Print">${icons.printer}</button>
                                <button onclick="handleLogout()" class="flex items-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-sm font-medium shadow-lg">${icons.logout} <span class="hidden md:inline">Logout</span></button>
                            </div>
                        </div>
                    </header>

                    <div class="flex flex-1 overflow-hidden">
                        <!-- Sidebar (Desktop) -->
                        <nav class="w-64 bg-white border-r border-gray-200 flex-shrink-0 overflow-y-auto hidden md:block no-print">
                            <div class="p-4 space-y-1">
                                ${renderNavButton('intro', '1. Report Configuration', 'Org details & facilities')}
                                <div class="h-px bg-gray-100 my-2"></div>
                                ${renderNavButton('tech', '2. Technical ACM', 'Internal Systems & Roles')}
                                ${renderNavButton('shared', '3. Shared / CRM', 'Cloud & External Partners')}
                                ${renderNavButton('cmmc', '4. CMMC Model Matrix', 'Evidence & Justification')}
                                <div class="h-px bg-gray-100 my-2"></div>
                                ${renderNavButton('report', 'View Full Report', 'Preview before printing')}
                            </div>
                            <div class="p-6 mt-10">
                                <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 text-xs text-slate-600">
                                    <strong class="block mb-2 text-slate-800">Instructions:</strong>
                                    Navigate tabs to build documentation. Data autosaves for <strong>${state.currentUser}</strong>.
                                </div>
                            </div>
                        </nav>

                        <!-- Mobile Nav -->
                        <nav class="md:hidden bg-white border-b border-gray-200 overflow-x-auto flex flex-shrink-0 no-print">
                            <div class="flex min-w-full p-2 gap-2">
                                ${renderMobileNavBtn('intro', 'Config')}
                                ${renderMobileNavBtn('tech', 'Tech ACM')}
                                ${renderMobileNavBtn('shared', 'Shared RM')}
                                ${renderMobileNavBtn('cmmc', 'CMMC Model')}
                                ${renderMobileNavBtn('report', 'Report')}
                            </div>
                        </nav>

                        <!-- Main Content -->
                        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50/50">
                            ${renderContent()}
                        </main>
                    </div>
                </div>
            `;
        }

        function renderNavButton(tab, label, desc) {
            const active = state.activeTab === tab;
            const baseClass = "w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group";
            const activeClass = "bg-slate-900 text-white shadow-md";
            const inactiveClass = "hover:bg-slate-100 text-slate-600";
            
            return `
                <button onclick="switchTab('${tab}')" class="${baseClass} ${active ? activeClass : inactiveClass}">
                    <div class="font-medium">${label}</div>
                    <div class="text-xs mt-0.5 ${active ? 'text-slate-300' : 'text-slate-400'}">${desc}</div>
                </button>
            `;
        }

        function renderMobileNavBtn(tab, label) {
            const active = state.activeTab === tab;
            return `<button onclick="switchTab('${tab}')" class="whitespace-nowrap px-3 py-1.5 rounded-full text-sm ${active ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700'}">${label}</button>`;
        }

        function renderContent() {
            switch (state.activeTab) {
                case 'intro': return renderIntroSection();
                case 'tech': return renderMatrixEditor('techEntries', 'Technical Access Control Matrix', 'Map subjects to objects.', 'Subjects must align with organizational roles (AC.L2-3.1.4).');
                case 'shared': return renderMatrixEditor('sharedEntries', 'Shared/Customer Responsibility Matrix', 'Document external partner controls.', 'Define the Share Partner explicitly.');
                case 'cmmc': return renderMatrixEditor('cmmcEntries', 'CMMC Model Matrix', 'Justification and Evidence.', 'Justification validates Least Privilege (AC.L2-3.1.5).');
                case 'report': return renderReportView();
                default: return '<div>Not Found</div>';
            }
        }

        function renderIntroSection() {
            const m = state.data.metadata;
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 max-w-4xl mx-auto mt-6 animate-fadeIn">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">Report Configuration</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organization Name</label>
                            <input type="text" value="${m.organizationName}" oninput="updateMetadata('organizationName', this.value)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Acme Cyber Defense">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Author</label>
                            <input type="text" value="${m.author}" oninput="updateMetadata('author', this.value)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Jane Doe, CISO">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Facilities</label>
                            <textarea oninput="updateMetadata('facilities', this.value)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none h-24">${m.facilities}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Completed</label>
                            <input type="date" value="${m.dateCompleted}" oninput="updateMetadata('dateCompleted', this.value)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Next Review Date</label>
                            <input type="date" value="${m.nextReviewDate}" oninput="updateMetadata('nextReviewDate', this.value)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="mt-8 bg-blue-50 border-l-4 border-blue-500 p-4 text-sm text-blue-700">
                        <strong>Professor's Note:</strong> The Date for Next Review demonstrates maintenance maturity (AC.L2-3.1.1).
                    </div>
                </div>
            `;
        }

        function renderMatrixEditor(type, title, desc, note) {
            const entries = state.data[type];
            let colHeaders = [];
            
            // Define columns based on type
            if(type === 'techEntries') colHeaders = ['Subject', 'Object/Resource', 'Permissions'];
            else if(type === 'sharedEntries') colHeaders = ['Subject', 'Object/Resource', 'Permissions', 'Share Partner'];
            else if(type === 'cmmcEntries') colHeaders = ['Subject ID', 'Object/Resource', 'Permission', 'Justification', 'Evidence'];

            const rowsHtml = entries.length === 0 
                ? `<tr><td colspan="${colHeaders.length + 1}" class="px-6 py-12 text-center text-gray-400">No entries found. Click "Add Entry".</td></tr>`
                : entries.map(row => `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-gray-100 last:border-0">
                        ${Object.keys(row).filter(k => k !== 'id').map(k => `<td class="px-6 py-4 whitespace-pre-wrap max-w-xs">${row[k]}</td>`).join('')}
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            <div class="flex justify-end gap-2">
                                <button onclick="openModal('${type}', '${row.id}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded">${icons.edit}</button>
                                <button onclick="deleteEntry('${type}', '${row.id}')" class="text-red-600 hover:bg-red-50 p-1 rounded">${icons.trash}</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            return `
                <div class="max-w-6xl mx-auto animate-fadeIn space-y-4">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div><h2 class="text-2xl font-bold text-slate-800">${title}</h2><p class="text-gray-600 mt-1">${desc}</p></div>
                            <button onclick="openModal('${type}')" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition shadow-sm">
                                ${icons.plus} Add Entry
                            </button>
                        </div>
                        <div class="flex gap-3 items-start bg-yellow-50 p-3 rounded-md border border-yellow-100 text-sm text-yellow-800 italic">
                            <div class="text-yellow-600 pt-0.5">${icons.info}</div> <p>${note}</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-700">
                                <thead class="text-xs text-gray-700 uppercase bg-slate-50 border-b border-gray-200">
                                    <tr>
                                        ${colHeaders.map(h => `<th class="px-6 py-3 font-semibold">${h}</th>`).join('')}
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>${rowsHtml}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReportView() {
            const d = state.data;
            const renderTable = (entries, cols) => `
                <table class="w-full text-sm text-left border-collapse border border-slate-300 mb-10 break-inside-avoid">
                    <thead class="bg-slate-100"><tr>${cols.map(c => `<th class="border border-slate-300 px-4 py-2">${c}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${entries.length ? entries.map(row => `
                            <tr>${Object.keys(row).filter(k=>k!=='id').map(k => `<td class="border border-slate-300 px-4 py-2">${row[k]}</td>`).join('')}</tr>
                        `).join('') : `<tr><td colspan="${cols.length}" class="text-center p-4 italic text-gray-500">No entries.</td></tr>`}
                    </tbody>
                </table>
            `;

            return `
                <div class="max-w-5xl mx-auto bg-white p-8 print:p-0 print:w-full animate-fadeIn">
                    <div class="text-center border-b-2 border-slate-800 pb-6 mb-8">
                        <h1 class="text-4xl font-bold text-slate-900 mb-2">Access Control Matrix</h1>
                        <p class="text-gray-500 uppercase tracking-widest font-semibold">CMMC Level 2 Audit Documentation</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-10 text-sm border border-gray-300 p-4 rounded-lg break-inside-avoid">
                        <div><span class="text-gray-500 font-semibold block">Organization:</span> <span class="font-medium text-lg">${d.metadata.organizationName || 'N/A'}</span></div>
                        <div><span class="text-gray-500 font-semibold block">Author:</span> <span class="font-medium text-lg">${d.metadata.author || 'N/A'}</span></div>
                        <div class="col-span-2"><span class="text-gray-500 font-semibold block">Facilities:</span> <span>${d.metadata.facilities || 'N/A'}</span></div>
                        <div><span class="text-gray-500 font-semibold block">Completed:</span> <span>${d.metadata.dateCompleted || 'N/A'}</span></div>
                        <div><span class="text-gray-500 font-semibold block">Review By:</span> <span>${d.metadata.nextReviewDate || 'N/A'}</span></div>
                    </div>

                    <h2 class="text-2xl font-bold text-slate-800 mb-4 border-l-4 border-blue-600 pl-3">1. Technical Access Control Matrix</h2>
                    ${renderTable(d.techEntries, ['Subject', 'Object/Resource', 'Permissions'])}

                    <h2 class="text-2xl font-bold text-slate-800 mb-4 border-l-4 border-green-600 pl-3 page-break">2. Shared/Customer Responsibility Matrix</h2>
                    ${renderTable(d.sharedEntries, ['Subject', 'Object/Resource', 'Permissions', 'Partner'])}

                    <h2 class="text-2xl font-bold text-slate-800 mb-4 border-l-4 border-purple-600 pl-3 page-break">3. CMMC Model Matrix</h2>
                    ${renderTable(d.cmmcEntries, ['Subject ID', 'Object', 'Permission', 'Justification', 'Evidence'])}
                    
                    <div class="text-center text-xs text-gray-400 mt-12 pt-4 border-t border-gray-200">Generated by CMMC Access Control Matrix Builder</div>
                </div>
            `;
        }

        // --- ACTIONS & EVENT HANDLERS ---

        // Delegate Auth Events
        document.addEventListener('submit', e => {
            if(e.target.id === 'auth-form') {
                e.preventDefault();
                handleAuth(new FormData(e.target));
            }
            if(e.target.id === 'modal-form') {
                e.preventDefault();
                saveEntry(new FormData(e.target));
            }
        });

        document.addEventListener('click', e => {
            if(e.target.id === 'toggle-auth') {
                state.isRegistering = !state.isRegistering;
                renderAuthScreen();
            }
            // Close modal on background click
            if(e.target.id === 'modal-overlay') {
                closeModal();
            }
        });

        function handleAuth(formData) {
            const u = formData.get('username');
            const p = formData.get('password');
            const users = JSON.parse(localStorage.getItem('cmmc-users') || '{}');
            const errorDiv = document.getElementById('auth-error');
            
            if(state.isRegistering) {
                if(users[u]) {
                    errorDiv.innerText = "Username taken.";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                users[u] = p;
                localStorage.setItem('cmmc-users', JSON.stringify(users));
                loginSuccess(u);
            } else {
                if(users[u] && users[u] === p) {
                    loginSuccess(u);
                } else {
                    errorDiv.innerText = "Invalid credentials.";
                    errorDiv.classList.remove('hidden');
                }
            }
        }

        function loginSuccess(username) {
            state.currentUser = username;
            state.isRegistering = false;
            localStorage.setItem('cmmc-session-user', username);
            loadUserData();
            render();
        }

        window.handleLogout = function() {
            state.currentUser = null;
            state.data = INITIAL_STATE;
            state.activeTab = 'intro';
            localStorage.removeItem('cmmc-session-user');
            render();
        };

        window.switchTab = function(tab) {
            state.activeTab = tab;
            renderDashboard(); // Re-render to update classes and content
        };

        window.updateMetadata = function(key, val) {
            state.data.metadata[key] = val;
            saveUserData();
            // No re-render needed for inputs, they hold their own state until refresh
        };

        // --- MODAL LOGIC ---

        window.openModal = function(type, id = null) {
            modalContext = { type, editingId: id };
            const entry = id ? state.data[type].find(e => e.id === id) : {};
            
            let fields = [];
            if (type === 'techEntries') fields = [
                { name: 'subject', label: 'Subject', placeholder: 'e.g. Network Admin' },
                { name: 'object', label: 'Object/Resource', placeholder: 'e.g. File Server' },
                { name: 'permission', label: 'Permissions', placeholder: 'e.g. Read, Write' }
            ];
            else if (type === 'sharedEntries') fields = [
                { name: 'subject', label: 'Subject', placeholder: 'e.g. MSP Admin' },
                { name: 'object', label: 'Object', placeholder: 'e.g. Hosted Exchange' },
                { name: 'permission', label: 'Permissions', placeholder: 'e.g. Full Control' },
                { name: 'partner', label: 'Share Partner', placeholder: 'e.g. AWS, Microsoft' }
            ];
            else if (type === 'cmmcEntries') fields = [
                { name: 'subjectId', label: 'Subject ID', placeholder: 'e.g. Role-DBA-01' },
                { name: 'object', label: 'Object', placeholder: 'e.g. CUI Repo A' },
                { name: 'permission', label: 'Permission', placeholder: 'e.g. Read-Only' },
                { name: 'justification', label: 'Justification', placeholder: 'Least privilege...' },
                { name: 'evidenceLink', label: 'Evidence Link', placeholder: 'Policy-AC-01.pdf' }
            ];

            const formHtml = `
                <div class="bg-slate-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">${id ? 'Edit Entry' : 'New Entry'}</h3>
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                <form id="modal-form" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    ${fields.map(f => `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${f.label}</label>
                            <textarea name="${f.name}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="${f.placeholder}" required>${entry[f.name] || ''}</textarea>
                        </div>
                    `).join('')}
                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-md">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md shadow-sm">Save Entry</button>
                    </div>
                </form>
            `;

            const modalOverlay = document.getElementById('modal-overlay');
            document.getElementById('modal-content').innerHTML = formHtml;
            modalOverlay.classList.remove('hidden');
            // small delay for transition
            setTimeout(() => modalOverlay.classList.remove('opacity-0'), 10);
        };

        window.closeModal = function() {
            const modalOverlay = document.getElementById('modal-overlay');
            modalOverlay.classList.add('opacity-0');
            setTimeout(() => modalOverlay.classList.add('hidden'), 300);
        };

        function saveEntry(formData) {
            const newEntry = { id: modalContext.editingId || crypto.randomUUID() };
            for(let [key, val] of formData.entries()) {
                newEntry[key] = val;
            }

            const list = state.data[modalContext.type];
            if(modalContext.editingId) {
                const idx = list.findIndex(e => e.id === modalContext.editingId);
                if(idx !== -1) list[idx] = newEntry;
            } else {
                list.push(newEntry);
            }
            
            saveUserData();
            closeModal();
            renderDashboard(); // Refresh table
        }

        window.deleteEntry = function(type, id) {
            if(!confirm('Are you sure?')) return;
            state.data[type] = state.data[type].filter(e => e.id !== id);
            saveUserData();
            renderDashboard();
        };

        window.downloadJSON = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `cmmc-matrix-${state.currentUser}-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.printReport = function() {
            switchTab('report');
            setTimeout(() => window.print(), 500);
        };

        // --- INIT ---
        loadUserData();
        render();

    </script>
</body>
</html>
